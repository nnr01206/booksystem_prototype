<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¡—è§’æ›¸åº—é¸æ›¸æœå‹™ | é›²ç«¯æ›¸åº«</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600&family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet" />

  <style>
    /* --- CSS æ¨£å¼ (ç¶­æŒ v3 è¨­è¨ˆé¢¨æ ¼) --- */
    :root {
      --primary-color: #008080;
      --primary-text: #ffffff;
      --background-color: #f8f9fa;
      --card-background: #ffffff;
      --text-color: #333333;
      --text-light: #666666;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --font-sans: "Noto Sans TC", sans-serif;
      --font-serif: "Noto Serif TC", serif;
      --active-filter-bg: #004d4d;
      --filter-hover-bg: #006666;
      --status-available: #28a745;
      --status-out: #dc3545;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-sans); background-color: var(--background-color); color: var(--text-color); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }

    /* Navbar */
    .navbar { background-color: var(--card-background); padding: 0.8rem 1rem; box-shadow: 0 2px 4px var(--shadow-color); position: sticky; top: 0; z-index: 100; text-align: center; }
    .navbar-brand { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); font-family: var(--font-serif); }

    /* Container */
    .container { max-width: 1100px; margin: 0 auto; padding: 1.5rem 1rem; flex: 1; width: 100%; }

    /* Filters */
    .filter-container { margin-bottom: 2rem; text-align: center; }
    .filter-button {
      background-color: var(--primary-color);
      color: var(--primary-text);
      border: none;
      padding: 0.5rem 1.2rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      margin: 0.3rem;
      transition: all 0.3s ease;
    }
    .filter-button:hover { background-color: var(--filter-hover-bg); transform: translateY(-2px); }
    .filter-button.active { background-color: var(--active-filter-bg); font-weight: bold; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }

    /* Grid */
    .book-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }

    /* Card */
    .book-card {
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: 0 2px 5px var(--shadow-color);
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }
    .book-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px var(--shadow-color); }
    
    .book-card figure { width: 100%; height: 250px; overflow: hidden; background-color: #eee; position: relative; margin: 0; }
    .book-card figure img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
    .book-card:hover figure img { transform: scale(1.05); }

    .book-card-body { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
    .book-card-body h2 { font-family: var(--font-serif); font-size: 1.1rem; margin-bottom: 0.3rem; color: var(--primary-color); line-height: 1.4; }
    .book-card-body .author { font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 500; }
    
    /* Status Badge */
    .status-badge {
        font-size: 0.75rem;
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        color: white;
        background-color: var(--status-available);
        align-self: flex-start;
        margin-bottom: 0.8rem;
    }
    .status-badge.out { background-color: var(--status-out); }

    .book-card-body .desc { font-size: 0.9rem; color: #555; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }

    /* Modal */
    .modal-toggle { display: none; }
    .modal { visibility: hidden; opacity: 0; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 1000; backdrop-filter: blur(2px); }
    .modal-box { background-color: var(--card-background); width: 90%; max-width: 800px; height: 85vh; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden; display: flex; flex-direction: column; }
    .modal-close-btn { position: absolute; top: 15px; right: 15px; background-color: rgba(0, 0, 0, 0.1); color: #333; border-radius: 50%; width: 32px; height: 32px; font-size: 1.2rem; line-height: 32px; text-align: center; cursor: pointer; z-index: 1010; transition: background 0.2s; }
    .modal-close-btn:hover { background-color: rgba(0, 0, 0, 0.2); }
    .modal-toggle:checked + .modal { visibility: visible; opacity: 1; }
    .modal-iframe { flex-grow: 1; border: none; width: 100%; height: 100%; }
    .modal-background-close { position: absolute; inset: 0; cursor: default; z-index: 999; }

    /* Footer */
    .footer { text-align: center; padding: 1.5rem; background-color: #e9ecef; color: var(--text-light); font-size: 0.85rem; margin-top: auto; }

    /* Loading */
    .loading-spinner { text-align: center; padding: 3rem; grid-column: 1 / -1; color: var(--primary-color); }
    .error-message { text-align: center; padding: 2rem; grid-column: 1 / -1; color: #d9534f; background: #fff5f5; border-radius: 8px; }

    /* RWD */
    @media (max-width: 900px) { .book-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { 
      .book-grid { grid-template-columns: 1fr; } 
      .modal-box { width: 100%; height: 100%; border-radius: 0; }
    }
  </style>
</head>
<body>

  <header class="navbar">
    <div class="navbar-brand">è¡—è§’æ›¸åº— Carreau de RÃ©verie</div>
  </header>

  <main class="container">
    <section id="category-filters" class="filter-container">
      </section>

    <section id="book-grid" class="book-grid">
      <div class="loading-spinner">ğŸ“š æ­£åœ¨é€£ç·šæ›¸åº«...</div>
    </section>
  </main>

  <input type="checkbox" id="formModalToggle" class="modal-toggle" />
  <div class="modal" role="dialog" aria-labelledby="modalTitle">
    <div class="modal-box">
       <label for="formModalToggle" class="modal-close-btn" title="é—œé–‰">âœ•</label>
       <iframe id="gForm" class="modal-iframe" loading="lazy" title="é¸æ›¸å•å·"></iframe>
    </div>
     <label for="formModalToggle" class="modal-background-close"></label>
  </div>

  <footer class="footer">
    <p>Â© 2025 è¡—è§’æ›¸åº— Carreau de RÃ©verie | InWave Studio</p>
  </footer>

  <script>
    /* --- è¨­å®šå€ --- */
    // Flask API åŸºç¤ç¶²å€
    const BASE_API_URL = "https://cornerbook.inwave-studio.com/api";
    
    // Google Form é å¡«é€£çµ (è«‹ç¢ºèª Entry ID æ­£ç¢º)
    const PREFILL_BASE = "https://docs.google.com/forms/d/e/1FAIpQLScTfAeqDFLhUMgBz2M0lA6iQV0pphdE8utSKs5ZX--cSwEVXw/viewform?usp=pp_url&entry.1687129680=";

    /* --- ç‹€æ…‹è®Šæ•¸ --- */
    let allBooks = []; 
    let categoriesMap = {}; // ç”¨æ–¼ ID å°æ‡‰åç¨± { 1: "ç§‘å¹»å°èªª" }
    let currentFilter = 'All';

    /* --- DOM å…ƒç´  --- */
    const categoryFiltersContainer = document.getElementById('category-filters');
    const bookGridContainer = document.getElementById('book-grid');
    const formModalToggle = document.getElementById('formModalToggle');
    const googleFormIframe = document.getElementById('gForm');

    /* --- 1. åˆå§‹åŒ–è³‡æ–™ --- */
    async function initData() {
      try {
        // ä¸¦è¡Œè«‹æ±‚ï¼šåŒæ™‚æŠ“å–ã€Œåˆ†é¡ã€èˆ‡ã€Œæ›¸ç±ã€
        const [categoriesResp, booksResp] = await Promise.all([
            fetch(`${BASE_API_URL}/categories`),
            fetch(`${BASE_API_URL}/books?per_page=0`) // per_page=0 è¡¨ç¤ºæŠ“å–å…¨éƒ¨ï¼Œä¸åšåˆ†é 
        ]);

        if (!booksResp.ok) throw new Error(`æ›¸ç±è¼‰å…¥å¤±æ•— (${booksResp.status})`);

        // è™•ç†åˆ†é¡è³‡æ–™
        if (categoriesResp.ok) {
            const categoriesData = await categoriesResp.json();
            // å»ºç«‹ ID å°æ‡‰åç¨±çš„ Map
            categoriesData.forEach(cat => {
                categoriesMap[cat.id] = cat.name;
            });
            renderCategoryButtons(categoriesData);
        }

        // è™•ç†æ›¸ç±è³‡æ–™
        const booksData = await booksResp.json();
        
        // æ³¨æ„ï¼šæ ¹æ“šæ–‡ä»¶ï¼ŒAPI å›å‚³æ ¼å¼ç‚º { "books": [...], "pagination": {...} }
        // æ‰€ä»¥æˆ‘å€‘è¦å– .books
        allBooks = booksData.books || [];

        console.log(`æˆåŠŸè¼‰å…¥ ${allBooks.length} æœ¬æ›¸ç±`);
        renderBooks('All');

      } catch (error) {
        console.error("API Error:", error);
        bookGridContainer.innerHTML = `
          <div class="error-message">
            <h3>âš ï¸ ç„¡æ³•é€£ç·šåˆ°æ›¸åº«</h3>
            <p>è«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œã€‚</p>
            <p style="font-size:0.8em; margin-top:10px;">${error.message}</p>
            <button onclick="location.reload()" style="margin-top:1rem; padding:0.5rem 1rem; cursor:pointer;">é‡æ–°æ•´ç†</button>
          </div>
        `;
      }
    }

    /* --- 2. æ¸²æŸ“åˆ†é¡æŒ‰éˆ• --- */
    function renderCategoryButtons(categories) {
      categoryFiltersContainer.innerHTML = '';

      // åŠ å…¥ "å…¨éƒ¨" æŒ‰éˆ•
      const allBtn = document.createElement('button');
      allBtn.className = 'filter-button active';
      allBtn.textContent = 'å…¨éƒ¨æ›¸ç±';
      allBtn.onclick = () => handleFilterClick('All', allBtn);
      categoryFiltersContainer.appendChild(allBtn);

      // åŠ å…¥ API å›å‚³çš„åˆ†é¡
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-button';
        btn.textContent = cat.name;
        // é€™è£¡æˆ‘å€‘ç”¨åˆ†é¡ ID ä¾†åšç¯©é¸éµå€¼
        btn.onclick = () => handleFilterClick(cat.id, btn);
        categoryFiltersContainer.appendChild(btn);
      });
    }

    function handleFilterClick(categoryId, btnElement) {
        currentFilter = categoryId;
        renderBooks(categoryId);
        
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
    }

    /* --- 3. æ¸²æŸ“æ›¸ç±åˆ—è¡¨ --- */
    function renderBooks(filterId) {
      bookGridContainer.innerHTML = '';

      // ç¯©é¸é‚è¼¯ï¼šå¦‚æœæ˜¯ 'All' å‰‡é¡¯ç¤ºå…¨éƒ¨ï¼Œå¦å‰‡æ¯”å° category_id
      const filtered = (filterId === 'All') 
        ? allBooks 
        : allBooks.filter(book => book.category_id === filterId);

      if (filtered.length === 0) {
        bookGridContainer.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding:3rem; color:#666;">é€™å€‹åˆ†é¡æš«ç„¡æ›¸ç±ã€‚</p>';
        return;
      }

      filtered.forEach(book => {
        const card = document.createElement('div');
        card.className = 'book-card';
        
        // è³‡æ–™æ¬„ä½å°æ‡‰
        const title = book.title || "æœªå‘½å";
        const author = book.author || "æœªçŸ¥ä½œè€…";
        // æ ¹æ“š API æ–‡ä»¶ï¼Œåœ–ç‰‡æ¬„ä½æ˜¯ image_url
        const cover = book.image_url || 'https://placehold.co/400x400?text=No+Cover';
        // API æ–‡ä»¶æœªæ˜ç¢ºåˆ—å‡º descriptionï¼Œè‹¥ç„¡å‰‡é¡¯ç¤ºé è¨­
        const desc = book.description || book.summary || "æš«ç„¡ç°¡ä»‹"; 
        
        // è¨ˆç®—åº«å­˜ç‹€æ…‹
        const available = book.available_quantity > 0;
        const statusText = available ? `åº«å­˜: ${book.available_quantity}` : "å·²å€Ÿå‡º";
        const statusClass = available ? "" : "out";

        card.innerHTML = `
          <figure>
            <img src="${cover}" alt="${title}" loading="lazy" onerror="this.src='https://placehold.co/400x400?text=Image+Error'; this.onerror=null;">
          </figure>
          <div class="book-card-body">
            <h2>${title}</h2>
            <p class="author">${author}</p>
            <span class="status-badge ${statusClass}">${statusText}</span>
            <p class="desc">${desc}</p>
          </div>
        `;

        // é»æ“Šäº‹ä»¶
        card.addEventListener('click', () => {
            // å¦‚æœå·²å€Ÿå‡ºï¼Œå¯ä»¥é¸æ“‡æ˜¯å¦è¦è·³å‡ºè¡¨å–®(é€™è£¡ä¿ç•™è·³å‡ºï¼Œä¹Ÿè¨±ä½¿ç”¨è€…æƒ³æ’éšŠ)
            const bookIdentifier = `${title}ï½œ${author}`;
            const formUrl = PREFILL_BASE + encodeURIComponent(bookIdentifier) + "&_=" + Date.now();
            
            googleFormIframe.src = formUrl;
            formModalToggle.checked = true;
        });

        bookGridContainer.appendChild(card);
      });
    }

    /* --- å•Ÿå‹• --- */
    document.addEventListener('DOMContentLoaded', () => {
      initData();

      // Modal é—œé–‰æ™‚é‡ç½®
      formModalToggle.addEventListener('change', () => {
        if (!formModalToggle.checked) {
            setTimeout(() => { googleFormIframe.src = 'about:blank'; }, 300);
        }
      });
    });
  </script>
</body>
</html>
